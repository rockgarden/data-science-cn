# AI 分析

## AI 提示词

提交《GB/T 36344-2018》 + 数据表结构 + 样例数据

根据提供的 `stg_starwb_fwbg_tzsbzhjk` 表结构、样例数据以及《GB/T 36344-2018》标准，生成一系列具体的 SQL 脚本，用于计算该表在各个数据质量维度下的量化指标。

这些脚本遵循标准中的 `X = A / B` 计算公式，您可以直接在数据库中执行以获取数据质量评分。

---

### **1. 规范性 (Conformity)**

#### **1.1 指标 0101: 数据标准 (Data Standard)**

- **目标**：检查 `wbzq` (维保周期) 和 `source` (来源) 是否符合预定义的标准列表。

```sql
-- 计算 wbzq 和 source 字段符合数据标准的比率
-- 假设标准的维保周期为：曳引电梯-半月, 曳引电梯-季度, 曳引电梯-年度
-- 假设标准的来源为：adszghz, hzxahz, szsrkj
SELECT
    COUNT(CASE
        WHEN wbzq IN ('曳引电梯-半月', '曳引电梯-季度', '曳引电梯-年度')
         AND source IN ('adszghz', 'hzxahz', 'szsrkj')
        THEN 1
    END) AS A,
    COUNT(*) AS B,
    ROUND(
        COUNT(CASE
            WHEN wbzq IN ('曳引电梯-半月', '曳引电梯-季度', '曳引电梯-年度')
             AND source IN ('adszghz', 'hzxahz', 'szsrkj')
            THEN 1
        END) * 1.0 /
        COUNT(*),
        4
    ) AS data_standard_ratio
FROM stg_starwb_fwbg_tzsbzhjk
WHERE stg_id IS NOT NULL; -- 确保记录存在
```

#### **1.2 指标 0102: 数据模型 (Data Model)**

- **目标**：检查 `equipment_code` (设备编号) 是否符合其 `char(9)` 的元数据定义（即长度为 9）。

```sql
-- 计算 equipment_code 字段符合元数据定义（长度为9）的比率
SELECT
    COUNT(CASE WHEN LENGTH(equipment_code) = 9 THEN 1 END) AS A,
    COUNT(*) AS B,
    ROUND(
        COUNT(CASE WHEN LENGTH(equipment_code) = 9 THEN 1 END) * 1.0 /
        COUNT(*),
        4
    ) AS data_model_ratio
FROM stg_starwb_fwbg_tzsbzhjk
WHERE equipment_code IS NOT NULL;
```

#### **1.3 指标 0103: 元数据 (Metadata)**

- **目标**：检查 `bysj` (保养日期) 是否为有效的 13 位毫秒级时间戳。

```sql
-- 计算 bysj 字段符合元数据定义（13位时间戳）的比率
SELECT
    COUNT(CASE WHEN bysj IS NOT NULL AND bysj >= 1000000000000 AND bysj < 10000000000000 THEN 1 END) AS A,
    COUNT(*) AS B,
    ROUND(
        COUNT(CASE WHEN bysj IS NOT NULL AND bysj >= 1000000000000 AND bysj < 10000000000000 THEN 1 END) * 1.0 /
        COUNT(*),
        4
    ) AS metadata_ratio
FROM stg_starwb_fwbg_tzsbzhjk;
```

#### **1.4 指标 0104: 业务规则 (Business Rules)**

- **目标**：检查当 `url1` (维保工 1 签字图片地址) 存在时，`user_name1` (维保工 1 姓名) 是否也存在。

```sql
-- 计算符合业务规则（有签字图则有姓名）的比率
SELECT
    COUNT(CASE
        WHEN url1 IS NOT NULL AND user_name1 IS NOT NULL THEN 1
        WHEN url1 IS NULL THEN 1 -- 无签字图，视为符合
        ELSE 0
    END) AS A,
    COUNT(*) AS B,
    ROUND(
        COUNT(CASE
            WHEN url1 IS NOT NULL AND user_name1 IS NOT NULL THEN 1
            WHEN url1 IS NULL THEN 1
            ELSE 0
        END) * 1.0 /
        COUNT(*),
        4
    ) AS business_rule_ratio
FROM stg_starwb_fwbg_tzsbzhjk;
```

#### **1.5 指标 0105: 权威参考数据 (Authoritative Reference Data)**

- **目标**：检查 `city_code` (城市代码) 是否在预定义的权威行政区划代码列表中。

```sql
-- 计算 city_code 字段引用权威参考数据的比率
-- 假设权威列表包含：330100 (杭州市), 330300 (温州市)
SELECT
    COUNT(CASE WHEN city_code IN ('330100', '330300') THEN 1 END) AS A,
    COUNT(*) AS B,
    ROUND(
        COUNT(CASE WHEN city_code IN ('330100', '330300') THEN 1 END) * 1.0 /
        COUNT(*),
        4
    ) AS reference_data_ratio
FROM stg_starwb_fwbg_tzsbzhjk
WHERE city_code IS NOT NULL;
```

#### **1.6 指标 0106: 安全规范 (Security Specification)**

- **目标**：检查 `user_phone` (用户电话) 字段是否经过脱敏处理（例如，包含 `*`）。

```sql
-- 计算 user_phone 字段符合安全规范（已脱敏）的比率
SELECT
    COUNT(CASE WHEN user_phone LIKE '%*%' THEN 1 END) AS A,
    COUNT(*) AS B,
    ROUND(
        COUNT(CASE WHEN user_phone LIKE '%*%' THEN 1 END) * 1.0 /
        COUNT(*),
        4
    ) AS security_spec_ratio
FROM stg_starwb_fwbg_tzsbzhjk
WHERE user_phone IS NOT NULL;
```

---

### **2. 完整性 (Completeness)**

#### **2.1 指标 0201: 数据元素完整性 (Data Element Completeness)**

- **目标**：检查核心字段 `zcdm`, `bysj`, `wbdw_mc`, `scrxm` 是否都已赋值。

```sql
-- 计算关键字段均不为空的记录比率
SELECT
    COUNT(CASE WHEN zcdm IS NOT NULL AND bysj IS NOT NULL AND wbdw_mc IS NOT NULL AND scrxm IS NOT NULL THEN 1 END) AS A,
    COUNT(*) AS B,
    ROUND(
        COUNT(CASE WHEN zcdm IS NOT NULL AND bysj IS NOT NULL AND wbdw_mc IS NOT NULL AND scrxm IS NOT NULL THEN 1 END) * 1.0 /
        COUNT(*),
        4
    ) AS element_completeness_ratio
FROM stg_starwb_fwbg_tzsbzhjk;
```

#### **2.2 指标 0202: 数据记录完整性 (Data Record Completeness)**

- **目标**：检查对于“半月”维保，是否至少有 `url1` 或 `url2` 中的一个签字图片。

```sql
-- 计算“半月”维保记录的签字完整性比率
SELECT
    COUNT(CASE
        WHEN wbzq = '曳引电梯-半月' AND (url1 IS NOT NULL OR url2 IS NOT NULL) THEN 1
        WHEN wbzq != '曳引电梯-半月' THEN 1 -- 其他维保周期不强制要求
        ELSE 0
    END) AS A,
    COUNT(*) AS B,
    ROUND(
        COUNT(CASE
            WHEN wbzq = '曳引电梯-半月' AND (url1 IS NOT NULL OR url2 IS NOT NULL) THEN 1
            WHEN wbzq != '曳引电梯-半月' THEN 1
            ELSE 0
        END) * 1.0 /
        COUNT(*),
        4
    ) AS record_completeness_ratio
FROM stg_starwb_fwbg_tzsbzhjk;
```

---

### **3. 准确性 (Accuracy)**

#### **3.1 指标 0301: 数据内容正确性 (Data Content Correctness)**

- **目标**：检查 `zcdm` (电梯注册代码) 和 `device_number` (设备代码) 是否相等（根据样例数据推测的业务规则）。

```sql
-- 计算 zcdm 和 device_number 相等的比率
SELECT
    COUNT(CASE WHEN zcdm = device_number THEN 1 END) AS A,
    COUNT(*) AS B,
    ROUND(
        COUNT(CASE WHEN zcdm = device_number THEN 1 END) * 1.0 /
        COUNT(*),
        4
    ) AS content_correctness_ratio
FROM stg_starwb_fwbg_tzsbzhjk
WHERE zcdm IS NOT NULL AND device_number IS NOT NULL;
```

#### **3.2 指标 0302: 数据格式合规性 (Data Format Compliance)**

- **目标**：检查 `lon` (经度) 和 `lat` (纬度) 是否在有效地理坐标范围内。

```sql
-- 计算 lon 和 lat 字段符合地理坐标格式的比率
SELECT
    COUNT(CASE
        WHEN lon IS NOT NULL AND lat IS NOT NULL
         AND CAST(lon AS DECIMAL(10,8)) BETWEEN -180 AND 180
         AND CAST(lat AS DECIMAL(10,8)) BETWEEN -90 AND 90
        THEN 1
    END) AS A,
    COUNT(*) AS B,
    ROUND(
        COUNT(CASE
            WHEN lon IS NOT NULL AND lat IS NOT NULL
             AND CAST(lon AS DECIMAL(10,8)) BETWEEN -180 AND 180
             AND CAST(lat AS DECIMAL(10,8)) BETWEEN -90 AND 90
            THEN 1
        END) * 1.0 /
        COUNT(*),
        4
    ) AS format_compliance_ratio
FROM stg_starwb_fwbg_tzsbzhjk;
```

#### **3.3 指标 0303: 数据重复率 (Data Duplication Rate)**

- **目标**：检查由唯一键 `uniq_idx` (`zcdm`, `bysj`, `source`) 定义的记录是否重复。

```sql
-- 计算由唯一键约束定义的重复记录比率
-- 由于有唯一索引，理论上应为0
WITH Duplicates AS (
    SELECT
        zcdm,
        bysj,
        source,
        COUNT(*) AS cnt
    FROM stg_starwb_fwbg_tzsbzhjk
    GROUP BY zcdm, bysj, source
    HAVING COUNT(*) > 1
)
SELECT
    COALESCE(SUM(d.cnt), 0) AS A,
    (SELECT COUNT(*) FROM stg_starwb_fwbg_tzsbzhjk) AS B,
    ROUND(
        COALESCE(SUM(d.cnt), 0) * 1.0 /
        (SELECT COUNT(*) FROM stg_starwb_fwbg_tzsbzhjk),
        4
    ) AS duplication_rate
FROM Duplicates d;
```

#### **3.4 指标 0304: 数据唯一性 (Data Uniqueness)**

- **目标**：检查 `fwbg_id` (UUID) 是否唯一。

```sql
-- 计算 fwbg_id 字段满足唯一性要求的比率
WITH Duplicates AS (
    SELECT
        fwbg_id,
        COUNT(*) AS cnt
    FROM stg_starwb_fwbg_tzsbzhjk
    GROUP BY fwbg_id
    HAVING COUNT(*) > 1
)
SELECT
    (SELECT COUNT(*) FROM stg_starwb_fwbg_tzsbzhjk) - COALESCE(SUM(cnt), 0) AS A, -- 唯一的记录数 = 总数 - 重复数
    (SELECT COUNT(*) FROM stg_starwb_fwbg_tzsbzhjk) AS B,
    ROUND(
        ((SELECT COUNT(*) FROM stg_starwb_fwbg_tzsbzhjk) - COALESCE(SUM(cnt), 0)) * 1.0 /
        (SELECT COUNT(*) FROM stg_starwb_fwbg_tzsbzhjk),
        4
    ) AS uniqueness_ratio
FROM Duplicates d;
```

#### **3.5 指标 0305: 脏数据出现率 (Dirty Data Occurrence Rate)**

- **目标**：检查 `scrxm` (上传人姓名) 字段中是否包含分隔符（如顿号、逗号），这可能表示多个值被合并。

```sql
-- 计算 scrxm 字段包含分隔符的脏数据出现率
SELECT
    COUNT(CASE WHEN scrxm REGEXP '[、,]' THEN 1 END) AS A,
    COUNT(*) AS B,
    ROUND(
        COUNT(CASE WHEN scrxm REGEXP '[、,]' THEN 1 END) * 1.0 /
        COUNT(*),
        4
    ) AS dirty_data_rate
FROM stg_starwb_fwbg_tzsbzhjk
WHERE scrxm IS NOT NULL;
```

---

### **4. 一致性 (Consistency)**

#### **4.1 指标 0401: 相同数据一致性 (Same Data Consistency)**

- **目标**：检查 `city_code` (城市代码) 和 `city_name` (城市名称) 是否匹配。

```sql
-- 计算 city_code 和 city_name 一致的比率
SELECT
    COUNT(CASE
        WHEN (city_code = '330100' AND city_name = '杭州市')
          OR (city_code = '330300' AND city_name = '温州市')
        THEN 1
        ELSE 0
    END) AS A,
    COUNT(*) AS B,
    ROUND(
        COUNT(CASE
            WHEN (city_code = '330100' AND city_name = '杭州市')
              OR (city_code = '330300' AND city_name = '温州市')
            THEN 1
            ELSE 0
        END) * 1.0 /
        COUNT(*),
        4
    ) AS same_data_consistency_ratio
FROM stg_starwb_fwbg_tzsbzhjk
WHERE city_code IS NOT NULL AND city_name IS NOT NULL;
```

#### **4.2 指标 0402: 关联数据一致性 (Associated Data Consistency)**

- **目标**：检查 `sign_time` (维保开始时间) 是否不晚于 `complete_time` (维保结束时间)。

```sql
-- 计算 sign_time <= complete_time 的比率
SELECT
    COUNT(CASE WHEN sign_time <= complete_time OR complete_time IS NULL THEN 1 END) AS A,
    COUNT(*) AS B,
    ROUND(
        COUNT(CASE WHEN sign_time <= complete_time OR complete_time IS NULL THEN 1 END) * 1.0 /
        COUNT(*),
        4
    ) AS associated_data_consistency_ratio
FROM stg_starwb_fwbg_tzsbzhjk
WHERE sign_time IS NOT NULL;
```

---

### **5. 时效性 (Timeliness)**

#### **5.2 指标 0502: 基于时间点及时性 (Timeliness Based on Time Point)**

- **目标**：计算 `bysj` (保养日期) 到 `stg_insert_time` (入库时间) 的延迟是否在 24 小时内。

```sql
-- 计算数据入库及时性比率（延迟<24小时）
SELECT
    COUNT(CASE
        WHEN stg_insert_time <= DATE_ADD(FROM_UNIXTIME(bysj/1000), INTERVAL 1 DAY) THEN 1
    END) AS A,
    COUNT(*) AS B,
    ROUND(
        COUNT(CASE
            WHEN stg_insert_time <= DATE_ADD(FROM_UNIXTIME(bysj/1000), INTERVAL 1 DAY) THEN 1
        END) * 1.0 /
        COUNT(*),
        4
    ) AS timeliness_ratio
FROM stg_starwb_fwbg_tzsbzhjk
WHERE bysj IS NOT NULL AND stg_insert_time IS NOT NULL;
```

#### **5.3 指标 0503: 时序性 (Sequentiality)**

- **目标**：检查 `create_time` (创建时间戳) 是否不大于 `update_time` (更新时间戳)。

```sql
-- 计算 create_time <= update_time 的比率
SELECT
    COUNT(CASE WHEN create_time <= update_time OR update_time IS NULL THEN 1 END) AS A,
    COUNT(*) AS B,
    ROUND(
        COUNT(CASE WHEN create_time <= update_time OR update_time IS NULL THEN 1 END) * 1.0 /
        COUNT(*),
        4
    ) AS sequentiality_ratio
FROM stg_starwb_fwbg_tzsbzhjk
WHERE create_time IS NOT NULL;
```

---

### **6. 可访问性 (Accessibility)**

#### **6.1 指标 0601: 可访问 (Accessible)**

- **目标**：此指标为系统级，SQL 无法直接测量。但可以检查通过主键查询的效率。

```sql
-- 此查询本身的成功执行证明了可访问性。实际监控需通过数据库性能工具。
-- 一个简单的测试查询
SELECT 'Data is accessible' AS status
FROM stg_starwb_fwbg_tzsbzhjk
LIMIT 1;
```

#### **6.2 指标 0602: 可用性 (Availability)**

- **目标**：检查表中是否存在任何记录，作为可用性的基本代理。

```sql
-- 计算表中存在记录的比率（应为1.0）
SELECT
    COUNT(*) AS A,
    (SELECT COUNT(*) FROM stg_starwb_fwbg_tzsbzhjk) AS B,
    ROUND(
        COUNT(*) * 1.0 /
        (SELECT COUNT(*) FROM stg_starwb_fwbg_tzsbzhjk),
        4
    ) AS availability_ratio
FROM stg_starwb_fwbg_tzsbzhjk;
```

---

**使用说明**：

1.  请根据您的实际业务规则调整脚本中的预定义值列表（如维保周期、来源、行政区划代码等）。
2.  将 `FROM_UNIXTIME(bysj/1000)` 调整为您的数据库处理毫秒时间戳的正确函数。
3.  这些脚本提供了量化评估的基础，建议将其集成到自动化数据质量监控流程中。
